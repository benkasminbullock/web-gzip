# For a request like
# http://www.example.org/xyz/index.html/garbage=here
# REQUEST_FILENAME=xyz/index.html
# PATH_INFO=/garbage=here
# So it's necessary to check that PATH_INFO is zero, with
#
# RewriteCond %{PATH_INFO} ^$

RewriteEngine On

RewriteCond %{HTTP:Accept-Encoding} gzip 
RewriteCond %{REQUEST_FILENAME}.gz -f 
RewriteCond %{PATH_INFO} ^$
RewriteRule ^(.*)$ $1.gz [L] 

RewriteCond %{HTTP:Accept-Encoding} !gzip 
RewriteCond %{REQUEST_FILENAME}.gz -f
RewriteRule ^(.+)$ send-uncompressed.cgi?$1

# Redirect for the case of directory indices.

RewriteCond %{HTTP:Accept-Encoding} !gzip
RewriteCond %{REQUEST_URI} /$
# Check there is not "index.cgi" in the directory..
RewriteCond %{REQUEST_FILENAME}index.cgi !-f
RewriteRule ^(.*)$ send-uncompressed.cgi?$1index.html

# The following is necessary once index.html is compressed, otherwise
# the top page will give a "forbidden" error.

DirectoryIndex index.html index.html.gz index.cgi

# Apache 2.4 specific - add a Vary: Accept-Encoding header.

<IfModule mod_headers.c>
  <FilesMatch ".(js|css|xml|gz|html)$">
    Header append Vary: Accept-Encoding
  </FilesMatch>
</IfModule>
